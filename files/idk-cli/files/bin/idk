#!/bin/sh
set -e

# TODO: look at gemrc

#
# Sanitize the environment
# ------------------------
#
# Remove from environment any Bundler's, RVM's, and other
# Ruby-mangling values that may confuse our commands.

if [ -n "$rvm_path" ] ; then
    export idk_rvm_path="$rvm_path"
else
    unset idk_rvm_path
fi

rubyvars_re='^\(rvm_.*\|RUBY_.*\|GEM_.*\|BUNDLE_.*\|MY_RUBY_HOME\|RUBYOPT\|IRBRC\)$'
for var in `env | cut -d= -f1 | grep "$rubyvars_re"` ; do
    unset $var
done

idk_rubyopt='-rubygems -ridk/cli'
# Allow hacking IDK
if [ -n "$IDK_CLI_PATH" ] ; then
    echo "# idk-cli: using CLI at $IDK_CLI_PATH"
    idk_rubyopt="-I$IDK_CLI_PATH/lib $idk_rubyopt"
fi

if [ -n "$PS1" ] ; then
    export idk_interactive="1"
fi

export IDK0="$0"
exec /opt/idk/embedded/bin/ruby $idk_rubyopt -e 'IDK::CLI.start' -- "${@}"
